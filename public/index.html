<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Fiscabot - DETRAN-AM</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="chat-container">
    <img src="fiscabot.png" alt="Fiscabot" style="width:80px;display:block;margin:10px auto;">
    <div id="chat-box"></div>
    <input type="text" id="user-input" placeholder="Digite aqui..." autofocus>
    <button onclick="sendMessage()">Enviar</button>
    <button onclick="iniciarReconhecimento()">ðŸŽ¤ Falar</button>
  </div>

  <script>
    const chatBox = document.getElementById("chat-box");
    const input = document.getElementById("user-input");

    let etapa = "inicio";
    let denuncia = {};

    function addMessage(sender, text) {
      const msg = document.createElement("div");
      msg.className = sender;
      msg.textContent = text;
      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;
      if (sender === "bot") falar(text); // fala em voz alta
    }

    function validarData(valor) {
      return /^\d{2}\/\d{2}\/\d{4}$/.test(valor);
    }

    function validarHora(valor) {
      return /^([01]\d|2[0-3]):[0-5]\d$/.test(valor);
    }

    function sendMessage() {
      const text = input.value.trim();
      if (!text) return;
      addMessage("user", text);
      input.value = "";

      switch (etapa) {
        case "inicio":
          addMessage("bot", "ðŸ‘®â€â™‚ï¸ OlÃ¡! Eu sou o Fiscabot, assistente do DETRAN-AM.\nSelecione o tipo de denÃºncia:\n1ï¸âƒ£ Rolezinho\n2ï¸âƒ£ Adega\n3ï¸âƒ£ Estacionamento irregular");
          etapa = "tipo";
          break;

        case "tipo":
          if (text === "1") { denuncia.tipo = "Rolezinho"; addMessage("bot", "ðŸ“ Informe o local do evento:"); etapa = "local"; }
          else if (text === "2") { denuncia.tipo = "Adega"; addMessage("bot", "ðŸª Informe o nome do local:"); etapa = "nome_local"; }
          else if (text === "3") {
            denuncia.tipo = "Estacionamento irregular";
            addMessage("bot", "ðŸš— Esse tipo de ocorrÃªncia Ã© de competÃªncia municipal.\nðŸ“ž Ligue: 0800 092 1188 ou (92) 98802-3782.");
            finalizarConversa();
          } else {
            addMessage("bot", "OpÃ§Ã£o invÃ¡lida. Escolha 1, 2 ou 3.");
          }
          break;

        // ROLEZINHO
        case "local":
          denuncia.local = text;
          addMessage("bot", "ðŸ˜ Informe o bairro:");
          etapa = "bairro";
          break;

        case "bairro":
          denuncia.bairro = text;
          addMessage("bot", "ðŸ“ Informe um ponto de referÃªncia:");
          etapa = "referencia";
          break;

        case "referencia":
          denuncia.referencia = text;
          addMessage("bot", "ðŸ“… Informe a data do evento (dd/mm/aaaa):");
          etapa = "data_evento";
          break;

        case "data_evento":
          if (!validarData(text)) { addMessage("bot", "âš ï¸ Data invÃ¡lida. Use o formato dd/mm/aaaa."); return; }
          denuncia.data_evento = text;
          addMessage("bot", "ðŸ—“ Qual o dia da semana?");
          etapa = "dia_semana";
          break;

        case "dia_semana":
          denuncia.dia_semana = text;
          addMessage("bot", "â° Informe a hora de inÃ­cio (HH:MM):");
          etapa = "hora_inicio";
          break;

        case "hora_inicio":
          if (!validarHora(text)) { addMessage("bot", "âš ï¸ Hora invÃ¡lida. Use o formato HH:MM."); return; }
          denuncia.hora_inicio = text;
          addMessage("bot", "â° Informe a hora de tÃ©rmino (HH:MM):");
          etapa = "hora_fim";
          break;

        case "hora_fim":
          if (!validarHora(text)) { addMessage("bot", "âš ï¸ Hora invÃ¡lida. Use o formato HH:MM."); return; }
          denuncia.hora_fim = text;
          addMessage("bot", "ðŸ“ Alguma observaÃ§Ã£o adicional?");
          etapa = "observacoes";
          break;

        // ADEGA
        case "nome_local":
          denuncia.nome_local = text;
          addMessage("bot", "ðŸ˜ Informe o bairro:");
          etapa = "bairro_adega";
          break;

        case "bairro_adega":
          denuncia.bairro = text;
          addMessage("bot", "ðŸ“ Informe o endereÃ§o completo:");
          etapa = "endereco";
          break;

        case "endereco":
          denuncia.endereco = text;
          addMessage("bot", "ðŸ—“ Qual o dia da semana mais movimentado?");
          etapa = "dia_semana_adega";
          break;

        case "dia_semana_adega":
          denuncia.dia_semana = text;
          addMessage("bot", "â° Qual o horÃ¡rio de maior movimentaÃ§Ã£o (HH:MM)?");
          etapa = "hora_inicio_adega";
          break;

        case "hora_inicio_adega":
          if (!validarHora(text)) { addMessage("bot", "âš ï¸ Hora invÃ¡lida. Use HH:MM."); return; }
          denuncia.hora_inicio = text;
          addMessage("bot", "â° Informe o horÃ¡rio de encerramento (HH:MM):");
          etapa = "hora_fim_adega";
          break;

        case "hora_fim_adega":
          if (!validarHora(text)) { addMessage("bot", "âš ï¸ Hora invÃ¡lida. Use HH:MM."); return; }
          denuncia.hora_fim = text;
          addMessage("bot", "ðŸ“ Alguma observaÃ§Ã£o adicional?");
          etapa = "observacoes";
          break;

        // FINALIZA
        case "observacoes":
          denuncia.observacoes = text;
          resumoDenuncia();
          salvarDenuncia();
          break;
      }
    }

    function resumoDenuncia() {
      addMessage("bot", "ðŸ“‘ Resumo da denÃºncia:");
      Object.entries(denuncia).forEach(([k, v]) => {
        addMessage("bot", `${k}: ${v}`);
      });
      addMessage("bot", "âœ… Obrigado! Sua denÃºncia foi registrada.");
      finalizarConversa();
    }

    async function salvarDenuncia() {
      try {
        const res = await fetch("/denuncia", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(denuncia)
        });
        const data = await res.json();
        if (data.success) {
          addMessage("bot", "ðŸ“¡ Dados enviados ao Supabase!");
        } else {
          addMessage("bot", "âš ï¸ Erro ao salvar denÃºncia no Supabase.");
        }
      } catch (err) {
        addMessage("bot", "âš ï¸ Erro de conexÃ£o com o servidor.");
      }
    }

    function finalizarConversa() {
      setTimeout(() => {
        document.body.innerHTML = "<h2 style='text-align:center; margin-top:50px;'>âœ… Conversa encerrada.</h2>";
      }, 3000);
    }

    // ðŸ”Š Voz: fala as respostas
    function falar(texto) {
      const utterance = new SpeechSynthesisUtterance(texto);
      utterance.lang = "pt-BR";
      speechSynthesis.speak(utterance);
    }

    // ðŸŽ¤ Voz: reconhecimento de fala
    function iniciarReconhecimento() {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = "pt-BR";
      recognition.onresult = function(event) {
        const texto = event.results[0][0].transcript;
        input.value = texto;
        sendMessage();
      };
      recognition.start();
    }

    // Start
    addMessage("bot", "ðŸ‘‹ Bem-vindo ao Fiscabot! Digite ou fale algo para comeÃ§ar.");
  </script>
</body>
</html>
