<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fiscabot - DETRAN-AM</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f7f7f7; padding:20px; }
    .chat-container{ max-width:520px; margin:0 auto; background:#fff; padding:12px; border-radius:8px; box-shadow: 0 2px 8px rgba(0,0,0,.05); }
    .logo { width:100%; max-height:180px; object-fit:contain; border-radius:10px; margin-bottom:8px; }
    .bot{ background:#0b61a4; color:#fff; padding:10px; margin:6px 0; border-radius:6px; white-space:pre-wrap; }
    .user{ background:#e9e9e9; color:#000; padding:10px; margin:6px 0; border-radius:6px; }
    .input-row{ display:flex; gap:8px; margin-top:10px; }
    input#userInput{ flex:1; padding:10px; border-radius:6px; border:1px solid #ccc; }
    button{ padding:10px 12px; border-radius:6px; border:none; background:#0b61a4; color:#fff; cursor:pointer; }
    .small{ font-size:12px; color:#666; margin-top:6px;}
  </style>
</head>
<body>
  <div class="chat-container">
    <!-- Imagem do bot (certifique-se que public/fiscabot.png exista) -->
    <img src="fiscabot.png" alt="Fiscabot" class="logo" />

    <div id="chat"></div>

    <div class="input-row">
      <input id="userInput" placeholder="Digite ou fale..." />
      <button id="sendBtn">Enviar</button>
    </div>
    <div class="small">Obs: use formato de data DD/MM/AAAA e hora HH:MM.</div>
  </div>

<script>
const chat = document.getElementById("chat");
const input = document.getElementById("userInput");
const sendBtn = document.getElementById("sendBtn");
let etapa = "menu";
let denuncia = {};

// Mostrar mensagem no chat
function addMessage(text, sender) {
  const msg = document.createElement("div");
  msg.className = sender;
  msg.textContent = text;
  chat.appendChild(msg);
  chat.scrollTop = chat.scrollHeight;
}

input.addEventListener("keypress", e => {
  if (e.key === "Enter") sendMessage();
});
sendBtn.addEventListener("click", sendMessage);

// ValidaÃ§Ãµes
function validarData(data) {
  const regex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
  if (!regex.test(data)) return false;
  const [dia, mes, ano] = data.split("/").map(Number);
  const d = new Date(ano, mes - 1, dia);
  return d.getFullYear() === ano && d.getMonth() === mes - 1 && d.getDate() === dia;
}
function validarHora(hora) {
  const regex = /^([01]\d|2[0-3]):([0-5]\d)$/;
  return regex.test(hora);
}
function mapVoiceToNumber(t) {
  const mapaFala = { "um": "1", "dois":"2", "trÃªs":"3", "tres":"3", "quatro":"4" };
  return mapaFala[t] || t;
}

// Init
addMessage("ðŸ‘®â€â™‚ï¸ OlÃ¡! Eu sou o Fiscabot, assistente da FiscalizaÃ§Ã£o de TrÃ¢nsito do DETRAN-AM.", "bot");
addMessage("Escolha uma opÃ§Ã£o:\n1 - Denunciar Rolezinho\n2 - Denunciar Adega com som\n3 - Denunciar estacionamento irregular\n4 - Encerrar", "bot");

async function sendMessage() {
  let text = input.value.trim().toLowerCase();
  if (!text) return;
  input.value = "";
  text = mapVoiceToNumber(text);
  addMessage(text, "user");

  switch (etapa) {
    case "menu":
      if (["1","2","3"].includes(text)) {
        denuncia = {}; // reset
        denuncia.tipo = text === "1" ? "Rolezinho" : text === "2" ? "Adega" : "Estacionamento irregular";
        etapa = "local";
        addMessage(`ðŸ“ Informe o local da ocorrÃªncia (${denuncia.tipo}):`, "bot");
      } else if (text === "4") {
        addMessage("âœ… Atendimento encerrado.", "bot");
      } else {
        addMessage("âŒ OpÃ§Ã£o invÃ¡lida. Diga 1,2,3 ou 4.", "bot");
      }
      break;

    case "local":
      denuncia.local = text;
      etapa = "bairro";
      addMessage("ðŸ˜ï¸ Informe o bairro (ou 'nÃ£o sei'):", "bot");
      break;

    case "bairro":
      denuncia.bairro = text === "nÃ£o sei" || text === "nao sei" ? null : text;
      etapa = "referencia";
      addMessage("ðŸ“Œ Informe um ponto de referÃªncia (ou 'nÃ£o sei'):", "bot");
      break;

    case "referencia":
      denuncia.referencia = text === "nÃ£o sei" || text === "nao sei" ? null : text;
      etapa = "data";
      addMessage("ðŸ“… Informe a data da ocorrÃªncia (ex: 15/10/2025):", "bot");
      break;

    case "data":
      if (!validarData(text)) {
        addMessage("âŒ Data invÃ¡lida! Use DD/MM/AAAA.", "bot");
      } else {
        denuncia.data_evento = text;
        etapa = "inicio";
        addMessage("â° Informe o horÃ¡rio de inÃ­cio (ex: 20:00):", "bot");
      }
      break;

    case "inicio":
      if (!validarHora(text)) {
        addMessage("âŒ HorÃ¡rio invÃ¡lido! Use HH:MM.", "bot");
      } else {
        denuncia.hora_inicio = text;
        etapa = "fim";
        addMessage("â° Informe o horÃ¡rio de tÃ©rmino (ex: 23:30):", "bot");
      }
      break;

    case "fim":
      if (!validarHora(text)) {
        addMessage("âŒ HorÃ¡rio invÃ¡lido! Use HH:MM.", "bot");
      } else {
        denuncia.hora_fim = text;
        etapa = "obs";
        addMessage("ðŸ“ Deseja adicionar alguma observaÃ§Ã£o? (ou diga 'nÃ£o')", "bot");
      }
      break;

    case "obs":
      denuncia.observacoes = (text === "nÃ£o" || text === "nao") ? "Nenhuma observaÃ§Ã£o." : text;
      etapa = "confirmar";
      addMessage(`âœ… Confirme os dados:
Tipo: ${denuncia.tipo}
Local: ${denuncia.local}
Bairro: ${denuncia.bairro || 'NÃ£o informado'}
ReferÃªncia: ${denuncia.referencia || 'NÃ£o informado'}
Data: ${denuncia.data_evento}
InÃ­cio: ${denuncia.hora_inicio}
Fim: ${denuncia.hora_fim}
ObservaÃ§Ãµes: ${denuncia.observacoes}`, "bot");
      addMessage("Deseja enviar? (1 - Sim / 2 - Cancelar)", "bot");
      break;

    case "confirmar":
      if (text === "1") {
        // validaÃ§Ã£o final
        if (!validarData(denuncia.data_evento) || !validarHora(denuncia.hora_inicio) || !validarHora(denuncia.hora_fim)) {
          addMessage("âŒ Dados invÃ¡lidos. Cancelando envio.", "bot");
          etapa = "menu";
          addMessage("Escolha uma nova opÃ§Ã£o (1-4):", "bot");
          return;
        }
        try {
          const res = await fetch("/denuncia", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(denuncia)
          });
          const data = await res.json();
          if (res.ok && data.success) {
            addMessage("âœ… DenÃºncia registrada com sucesso!", "bot");
          } else {
            addMessage("âŒ Erro ao registrar denÃºncia: " + (data.message || JSON.stringify(data.error)), "bot");
          }
        } catch (err) {
          addMessage("âš ï¸ Falha de conexÃ£o com o servidor.", "bot");
          console.error("Erro fetch:", err);
        }
        etapa = "menu";
        addMessage("Escolha uma nova opÃ§Ã£o (1-4):", "bot");
      } else {
        addMessage("ðŸš« DenÃºncia cancelada.", "bot");
        etapa = "menu";
        addMessage("Escolha uma nova opÃ§Ã£o (1-4):", "bot");
      }
      break;
  }
}

// speech recognition (opcional)
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = new SpeechRecognition();
  recognition.lang = 'pt-BR';
  recognition.continuous = false;

  const micBtn = document.createElement("button");
  micBtn.textContent = "ðŸŽ™ï¸ Falar";
  micBtn.style.marginLeft = "6px";
  document.querySelector(".input-row").appendChild(micBtn);

  micBtn.onclick = () => {
    recognition.start();
    addMessage("(ðŸŽ§ Ouvindo... fale agora)", "bot");
  };

  recognition.onresult = (e) => {
    const txt = e.results[0][0].transcript.toLowerCase();
    input.value = txt;
    sendMessage();
  };
}
</script>
</body>
</html>
