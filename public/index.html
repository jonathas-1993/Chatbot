<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fiscabot - DETRAN-AM</title>
  <style>
    /* m√≠nimo estilo para legibilidade */
    body { font-family: Arial, sans-serif; background:#f7f7f7; padding:20px; }
    .chat-container{ max-width:520px; margin:0 auto; background:#fff; padding:12px; border-radius:8px; box-shadow: 0 2px 8px rgba(0,0,0,.05); }
    .bot{ background:#0b61a4; color:#fff; padding:10px; margin:6px 0; border-radius:6px; }
    .user{ background:#e9e9e9; color:#000; padding:10px; margin:6px 0; border-radius:6px; }
    .input-row{ display:flex; gap:8px; margin-top:10px; }
    input#userInput{ flex:1; padding:10px; border-radius:6px; border:1px solid #ccc; }
    button{ padding:10px 12px; border-radius:6px; border:none; background:#0b61a4; color:#fff; cursor:pointer; }
    .small{ font-size:12px; color:#666; margin-top:6px;}
  </style>
</head>
<body>
  <div class="chat-container">
    <div id="chat"></div>

    <div class="input-row">
      <input id="userInput" placeholder="Digite ou fale..." />
      <button id="sendBtn">Enviar</button>
    </div>
    <div class="small">Obs: use formato de data DD/MM/AAAA e hora HH:MM.</div>
  </div>

<script>
const chat = document.getElementById("chat");
const input = document.getElementById("userInput");
const sendBtn = document.getElementById("sendBtn");
let etapa = "menu";
let denuncia = {};

function addMessage(text, sender) {
  const msg = document.createElement("div");
  msg.className = sender;
  msg.textContent = text;
  chat.appendChild(msg);
  chat.scrollTop = chat.scrollHeight;
}

input.addEventListener("keypress", e => {
  if (e.key === "Enter") sendMessage();
});
sendBtn.addEventListener("click", sendMessage);

// valida√ß√µes
function validarData(data) {
  const regex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
  if (!regex.test(data)) return false;
  const [dia, mes, ano] = data.split("/").map(Number);
  const d = new Date(ano, mes - 1, dia);
  return d.getFullYear() === ano && d.getMonth() === mes - 1 && d.getDate() === dia;
}
function validarHora(hora) {
  const regex = /^([01]\d|2[0-3]):([0-5]\d)$/;
  return regex.test(hora);
}

// in√≠cio
addMessage("üëÆ‚Äç‚ôÇÔ∏è Ol√°! Eu sou o Fiscabot, assistente do DETRAN-AM.", "bot");
addMessage("Escolha uma op√ß√£o:\n1 - Denunciar Rolezinho\n2 - Denunciar Adega com som\n3 - Denunciar estacionamento irregular\n4 - Encerrar", "bot");

function mapVoiceToNumber(t) {
  const mapaFala = { "um": "1", "dois":"2", "tr√™s":"3", "tres":"3", "quatro":"4" };
  return mapaFala[t] || t;
}

async function sendMessage() {
  let text = input.value.trim().toLowerCase();
  if (!text) return;
  input.value = "";
  text = mapVoiceToNumber(text);
  addMessage(text, "user");

  switch (etapa) {
    case "menu":
      if (["1","2","3"].includes(text)) {
        denuncia.tipo = text === "1" ? "Rolezinho" : text === "2" ? "Adega" : "Estacionamento irregular";
        etapa = "local";
        addMessage(`üìç Informe o local da ocorr√™ncia (${denuncia.tipo}):`, "bot");
      } else if (text === "4") {
        addMessage("‚úÖ Atendimento encerrado.", "bot");
      } else {
        addMessage("‚ùå Op√ß√£o inv√°lida. Diga 1,2,3 ou 4.", "bot");
      }
      break;

    case "local":
      denuncia.local = text;
      etapa = "data";
      addMessage("üìÖ Informe a data da ocorr√™ncia (ex: 15/10/2025):", "bot");
      break;

    case "data":
      if (!validarData(text)) {
        addMessage("‚ùå Data inv√°lida! Use DD/MM/AAAA.", "bot");
      } else {
        denuncia.data_evento = text;
        etapa = "inicio";
        addMessage("‚è∞ Informe o hor√°rio de in√≠cio (ex: 20:00):", "bot");
      }
      break;

    case "inicio":
      if (!validarHora(text)) {
        addMessage("‚ùå Hor√°rio inv√°lido! Use HH:MM.", "bot");
      } else {
        denuncia.hora_inicio = text;
        etapa = "fim";
        addMessage("‚è∞ Informe o hor√°rio de t√©rmino (ex: 23:30):", "bot");
      }
      break;

    case "fim":
      if (!validarHora(text)) {
        addMessage("‚ùå Hor√°rio inv√°lido! Use HH:MM.", "bot");
      } else {
        denuncia.hora_fim = text;
        etapa = "obs";
        addMessage("üìù Deseja adicionar alguma observa√ß√£o? (ou diga 'n√£o')", "bot");
      }
      break;

    case "obs":
      denuncia.observacoes = (text === "n√£o" || text === "nao") ? "Nenhuma observa√ß√£o." : text;
      etapa = "confirmar";
      addMessage(`‚úÖ Confirme os dados:
Tipo: ${denuncia.tipo}
Local: ${denuncia.local}
Data: ${denuncia.data_evento}
In√≠cio: ${denuncia.hora_inicio}
Fim: ${denuncia.hora_fim}
Observa√ß√µes: ${denuncia.observacoes}`, "bot");
      addMessage("Deseja enviar? (1 - Sim / 2 - Cancelar)", "bot");
      break;

    case "confirmar":
      if (text === "1") {
        // valida√ß√£o final antes do envio
        if (!validarData(denuncia.data_evento) || !validarHora(denuncia.hora_inicio) || !validarHora(denuncia.hora_fim)) {
          addMessage("‚ùå Dados inv√°lidos. Cancelando envio.", "bot");
          etapa = "menu";
          addMessage("Escolha uma nova op√ß√£o (1-4):", "bot");
          return;
        }
        try {
          const res = await fetch("/denuncia", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(denuncia)
          });
          const data = await res.json();
          if (res.ok && data.success) addMessage("‚úÖ Den√∫ncia registrada com sucesso!", "bot");
          else addMessage("‚ùå Erro ao registrar den√∫ncia: " + (data.message || JSON.stringify(data.error)), "bot");
        } catch (err) {
          addMessage("‚ö†Ô∏è Falha de conex√£o com o servidor.", "bot");
          console.error("Erro fetch:", err);
        }
        etapa = "menu";
        addMessage("Escolha uma nova op√ß√£o (1-4):", "bot");
      } else {
        addMessage("üö´ Den√∫ncia cancelada.", "bot");
        etapa = "menu";
        addMessage("Escolha uma nova op√ß√£o (1-4):", "bot");
      }
      break;
  }
}

// speech recognition (se dispon√≠vel) - opcional, n√£o altera envio
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = new SpeechRecognition();
  recognition.lang = 'pt-BR';
  recognition.continuous = false;

  const micBtn = document.createElement("button");
  micBtn.textContent = "üéôÔ∏è Falar";
  micBtn.style.marginLeft = "6px";
  document.querySelector(".input-row").appendChild(micBtn);

  micBtn.onclick = () => {
    recognition.start();
    addMessage("(üéß Ouvindo... fale agora)", "bot");
  };

  recognition.onresult = (e) => {
    const txt = e.results[0][0].transcript.toLowerCase();
    input.value = txt;
    sendMessage();
  };
}
</script>
</body>
</html>
