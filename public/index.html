<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Fiscabot - DETRAN-AM</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="chat-container">
    <img src="fiscabot.png" alt="Fiscabot - DETRAN-AM">
    <div id="chat-box"></div>
    <div style="display:flex; width:100%; margin-top:5px;">
      <input type="text" id="user-input" placeholder="Digite aqui..." autofocus>
      <button onclick="sendMessage()">Enviar</button>
      <button onclick="iniciarReconhecimento()">ðŸŽ¤ Falar</button>
    </div>
  </div>

  <script>
    const chatBox = document.getElementById("chat-box");
    const input = document.getElementById("user-input");

    let etapa = "inicio";
    let denuncia = {};

    const diasValidos = ["segunda", "segunda-feira","terÃ§a","terÃ§a-feira","quarta","quarta-feira","quinta","quinta-feira","sexta","sexta-feira","sÃ¡bado","sabado","domingo"];

    function addMessage(sender, text) {
      const msg = document.createElement("div");
      msg.className = sender;
      msg.textContent = text;
      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;
      if(sender==="bot") falar(text);
    }

    function validarData(valor) { return /^\d{2}\/\d{2}\/\d{4}$/.test(valor); }
    function validarHora(valor) { return /^([01]\d|2[0-3]):[0-5]\d$/.test(valor); }

    function validarDia(texto){
      return diasValidos.includes(texto.toLowerCase());
    }

    function falar(texto){
      texto = texto.replace(/ðŸŽ¶/g,"mÃºsica")
                   .replace(/ðŸ»/g,"cerveja")
                   .replace(/ðŸš—/g,"carro")
                   .replace(/âœ…/g,"concluÃ­do")
                   .replace(/ðŸ“…/g,"data")
                   .replace(/â°/g,"hora")
                   .replace(/ðŸ“/g,"local")
                   .replace(/ðŸ˜/g,"bairro")
                   .replace(/ðŸª/g,"estabelecimento")
                   .replace(/ðŸ“‘/g,"resumo");
      const utterance = new SpeechSynthesisUtterance(texto);
      utterance.lang="pt-BR";
      speechSynthesis.speak(utterance);
    }

    function iniciarReconhecimento() {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = "pt-BR";
      recognition.onresult = function(event){
        input.value = event.results[0][0].transcript;
        sendMessage();
      };
      recognition.start();
    }

    async function salvarDenuncia() {
      try{
        const res = await fetch("/denuncia",{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify(denuncia)
        });
        const data = await res.json();
        if(data.success) addMessage("bot","Dados enviados ao Supabase!");
        else addMessage("bot","Erro ao salvar denÃºncia no Supabase.");
      } catch(err){
        addMessage("bot","Erro de conexÃ£o com o servidor.");
      }
    }

    function finalizarConversa(){
      setTimeout(()=>{document.body.innerHTML="<h2 style='text-align:center; margin-top:50px;'>Conversa encerrada.</h2>";},3000);
    }

    function sendMessage(){
      const text = input.value.trim();
      if(!text) return;
      addMessage("user",text);
      input.value = "";

      switch(etapa){
        case "inicio":
          addMessage("bot","OlÃ¡! Eu sou o Fiscabot, assistente do DETRAN-AM.\nEscolha o tipo de denÃºncia:\n1 Rolezinho\n2 Adega\n3 Estacionamento irregular");
          etapa="tipo";
          break;

        case "tipo":
          if(text==="1"){denuncia.tipo="Rolezinho"; addMessage("bot","Informe o local do evento:"); etapa="local";}
          else if(text==="2"){denuncia.tipo="Adega"; addMessage("bot","Informe o nome do estabelecimento:"); etapa="nome_local";}
          else if(text==="3"){denuncia.tipo="Estacionamento irregular"; addMessage("bot","Esse tipo Ã© municipal. Ligue 0800 092 1188."); finalizarConversa();}
          else addMessage("bot","OpÃ§Ã£o invÃ¡lida. Escolha 1, 2 ou 3.");
          break;

        case "local": denuncia.local=text; addMessage("bot","Informe o bairro:"); etapa="bairro"; break;
        case "bairro": denuncia.bairro=text; addMessage("bot","Informe um ponto de referÃªncia:"); etapa="referencia"; break;
        case "referencia": denuncia.referencia=text; addMessage("bot","Informe a data do evento (dd/mm/aaaa):"); etapa="data_evento"; break;
        case "data_evento":
          if(!validarData(text)){addMessage("bot","Data invÃ¡lida. Use dd/mm/aaaa."); return;}
          denuncia.data_evento=text; addMessage("bot","Qual o dia da semana?"); etapa="dia_semana"; break;
        case "dia_semana":
          if(!validarDia(text)){addMessage("bot","Dia invÃ¡lido. Informe: segunda, terÃ§a, quarta, quinta, sexta, sÃ¡bado ou domingo."); return;}
          denuncia.dia_semana=text; addMessage("bot","Informe a hora de inÃ­cio (HH:MM):"); etapa="hora_inicio"; break;
        case "hora_inicio":
          if(!validarHora(text)){addMessage("bot","Hora invÃ¡lida. Use HH:MM."); return;}
          denuncia.hora_inicio=text; addMessage("bot","Informe a hora de tÃ©rmino (HH:MM):"); etapa="hora_fim"; break;
        case "hora_fim":
          if(!validarHora(text)){addMessage("bot","Hora invÃ¡lida. Use HH:MM."); return;}
          denuncia.hora_fim=text; addMessage("bot","Alguma observaÃ§Ã£o adicional?"); etapa="observacoes"; break;
        case "observacoes":
          denuncia.observacoes=text; resumoDenuncia(); salvarDenuncia(); break;
        case "nome_local": denuncia.nome_local=text; addMessage("bot","Informe o bairro:"); etapa="bairro_adega"; break;
        case "bairro_adega": denuncia.bairro=text; addMessage("bot","Informe o endereÃ§o completo:"); etapa="endereco"; break;
        case "endereco": denuncia.endereco=text; addMessage("bot","Qual o dia da semana mais movimentado?"); etapa="dia_semana_adega"; break;
        case "dia_semana_adega":
          if(!validarDia(text)){addMessage("bot","Dia invÃ¡lido. Informe: segunda, terÃ§a, quarta, quinta, sexta, sÃ¡bado ou domingo."); return;}
          denuncia.dia_semana=text; addMessage("bot","Informe o horÃ¡rio de maior movimentaÃ§Ã£o (HH:MM):"); etapa="hora_inicio_adega"; break;
        case "hora_inicio_adega":
          if(!validarHora(text)){addMessage("bot","Hora invÃ¡lida."); return;}
          denuncia.hora_inicio=text; addMessage("bot","Informe o horÃ¡rio de encerramento (HH:MM):"); etapa="hora_fim_adega"; break;
        case "hora_fim_adega":
          if(!validarHora(text)){addMessage("bot","Hora invÃ¡lida."); return;}
          denuncia.hora_fim=text; addMessage("bot","Alguma observaÃ§Ã£o adicional?"); etapa="observacoes"; break;
      }
    }

    function resumoDenuncia(){
      addMessage("bot","Resumo da denÃºncia:");
      Object.entries(denuncia).forEach(([k,v])=>{addMessage("bot",`${k}: ${v}`);});
      addMessage("bot","Obrigado! Sua denÃºncia foi registrada."); finalizarConversa();
    }

    addMessage("bot","Bem-vindo ao Fiscabot! Digite ou fale algo para comeÃ§ar.");
  </script>
</body>
</html>
