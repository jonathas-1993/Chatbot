<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fiscabot - DETRAN-AM</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="chat-container">
    <img src="fiscabot.png" alt="Fiscabot" style="width: 100%; border-radius: 12px; margin-bottom: 10px;">
    <div id="chat"></div>

    <div class="input-row">
      <input id="userInput" placeholder="Digite ou fale..." />
      <button id="sendBtn">Enviar</button>
    </div>
  </div>

  <script>
    const chat = document.getElementById("chat");
    const input = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");
    let etapa = "menu";
    let denuncia = {};

    // Mostrar mensagem no chat
    function addMessage(text, sender) {
      const msg = document.createElement("div");
      msg.className = sender;
      msg.textContent = text;
      chat.appendChild(msg);
      chat.scrollTop = chat.scrollHeight;
    }

    // Envio automÃ¡tico com ENTER
    input.addEventListener("keypress", e => {
      if (e.key === "Enter") sendMessage();
    });
    sendBtn.addEventListener("click", sendMessage);

    // InÃ­cio
    addMessage("ðŸ‘®â€â™‚ï¸ OlÃ¡! Eu sou o Fiscabot, assistente do DETRAN-AM.", "bot");
    addMessage("Escolha uma opÃ§Ã£o:\n1 - Denunciar Rolezinho\n2 - Denunciar Adega com som\n3 - Denunciar estacionamento irregular\n4 - Encerrar", "bot");

    function validarData(data) {
      const regex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
      if (!regex.test(data)) return false;
      const [dia, mes, ano] = data.split("/").map(Number);
      const d = new Date(ano, mes - 1, dia);
      return d.getFullYear() === ano && d.getMonth() === mes - 1 && d.getDate() === dia;
    }

    function validarHora(hora) {
      const regex = /^([01]\d|2[0-3]):([0-5]\d)$/;
      return regex.test(hora);
    }

    async function sendMessage() {
      let text = input.value.trim().toLowerCase();
      if (!text) return;
      input.value = "";
      addMessage(text, "user");

      // converter fala â€œumâ€, â€œdoisâ€ etc para nÃºmero
      const mapaFala = { "um": "1", "dois": "2", "trÃªs": "3", "tres": "3", "quatro": "4" };
      if (mapaFala[text]) text = mapaFala[text];

      switch (etapa) {
        case "menu":
          if (["1", "2", "3"].includes(text)) {
            denuncia.tipo = text === "1" ? "Rolezinho" : text === "2" ? "Adega" : "Estacionamento irregular";
            etapa = "local";
            addMessage(`ðŸ“ Informe o local da ocorrÃªncia (${denuncia.tipo}):`, "bot");
          } else if (text === "4") {
            addMessage("âœ… Atendimento encerrado. ðŸš¦", "bot");
          } else {
            addMessage("âŒ OpÃ§Ã£o invÃ¡lida. Diga ou digite 1, 2, 3 ou 4.", "bot");
          }
          break;

        case "local":
          denuncia.local = text;
          etapa = "data";
          addMessage("ðŸ“… Informe a data da ocorrÃªncia (ex: 15/10/2025):", "bot");
          break;

        case "data":
          if (!validarData(text)) {
            addMessage("âŒ Data invÃ¡lida! Use o formato DD/MM/AAAA e uma data real.", "bot");
          } else {
            denuncia.data_evento = text;
            etapa = "inicio";
            addMessage("â° Informe o horÃ¡rio de inÃ­cio (ex: 20:00):", "bot");
          }
          break;

        case "inicio":
          if (!validarHora(text)) {
            addMessage("âŒ HorÃ¡rio invÃ¡lido! Use o formato HH:MM (00:00 a 23:59).", "bot");
          } else {
            denuncia.hora_inicio = text;
            etapa = "fim";
            addMessage("â° Informe o horÃ¡rio de tÃ©rmino (ex: 23:30):", "bot");
          }
          break;

        case "fim":
          if (!validarHora(text)) {
            addMessage("âŒ HorÃ¡rio invÃ¡lido! Use o formato HH:MM.", "bot");
          } else {
            denuncia.hora_fim = text;
            etapa = "obs";
            addMessage("ðŸ“ Deseja adicionar alguma observaÃ§Ã£o?", "bot");
          }
          break;

        case "obs":
          denuncia.observacoes = text || "Nenhuma observaÃ§Ã£o.";
          etapa = "confirmar";
          addMessage(`âœ… Confirme os dados:
Tipo: ${denuncia.tipo}
Local: ${denuncia.local}
Data: ${denuncia.data_evento}
InÃ­cio: ${denuncia.hora_inicio}
Fim: ${denuncia.hora_fim}
ObservaÃ§Ãµes: ${denuncia.observacoes}`, "bot");
          addMessage("Deseja enviar? (1 - Sim / 2 - Cancelar)", "bot");
          break;

        case "confirmar":
          if (text === "1") {
            try {
              const res = await fetch("/denuncia", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(denuncia)
              });
              const data = await res.json();
              if (data.success) addMessage("âœ… DenÃºncia registrada com sucesso!", "bot");
              else addMessage("âŒ Erro ao registrar denÃºncia.", "bot");
            } catch {
              addMessage("âš ï¸ Falha de conexÃ£o com o servidor.", "bot");
            }
            etapa = "menu";
            addMessage("Escolha uma nova opÃ§Ã£o (1-4):", "bot");
          } else {
            addMessage("ðŸš« DenÃºncia cancelada.", "bot");
            etapa = "menu";
            addMessage("Escolha uma nova opÃ§Ã£o (1-4):", "bot");
          }
          break;
      }
    }

    // ðŸŽ¤ Reconhecimento de fala (nÃ£o salva Ã¡udio)
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      recognition.lang = 'pt-BR';
      recognition.continuous = false;

      const micBtn = document.createElement("button");
      micBtn.textContent = "ðŸŽ™ï¸ Falar";
      micBtn.style.marginLeft = "5px";
      document.querySelector(".input-row").appendChild(micBtn);

      micBtn.onclick = () => {
        recognition.start();
        addMessage("(ðŸŽ§ Ouvindo... fale agora)", "bot");
      };

      recognition.onresult = (e) => {
        const text = e.results[0][0].transcript.toLowerCase();
        input.value = text;
        sendMessage();
      };
    }
  </script>
</body>
</html>
