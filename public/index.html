<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fiscabot - DETRAN-AM</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="chat-container">
    <img src="fiscabot.png" alt="Fiscabot" style="width: 100%; border-radius: 12px; margin-bottom: 10px;">
    <div id="chat"></div>
    <div class="input-row">
      <input id="userInput" placeholder="Digite sua resposta..." />
      <button onclick="sendMessage()">Enviar</button>
    </div>
  </div>

  <script>
    const chat = document.getElementById("chat");
    let etapa = "menu";
    let denuncia = {
      tipo: "",
      local: "",
      data_evento: "",
      dia_semana: "",
      inicio: "",
      fim: "",
      obs: ""
    };

    function addMessage(text, sender) {
      const msg = document.createElement("div");
      msg.className = sender;
      msg.textContent = text;
      chat.appendChild(msg);
      chat.scrollTop = chat.scrollHeight;
    }

    // Mensagem inicial
    addMessage("üëÆ‚Äç‚ôÇÔ∏è Ol√°! Eu sou o Fiscabot, assistente de fiscaliza√ß√£o do DETRAN-AM.", "bot");
    addMessage("Este canal √© destinado a den√∫ncias de irregularidades de tr√¢nsito conforme o CTB. Para assuntos de habilita√ß√£o, ve√≠culos ou multas, ligue para (92) 3643-0001 ou acesse: https://www.detran.am.gov.br/servicos/agendamento-parqueamento/", "bot");
    mostrarMenu();

    function mostrarMenu() {
      etapa = "menu";
      addMessage(`Escolha uma op√ß√£o:
1 - Denunciar aglomera√ß√£o irregular de motociclistas ("Rolezinho")
2 - Denunciar atividade de "Adega" com som automotivo
3 - Denunciar estacionamento irregular
4 - Encerrar atendimento`, "bot");
    }

    async function sendMessage() {
      const input = document.getElementById("userInput");
      const text = input.value.trim();
      if (!text) return;
      addMessage(text, "user");
      input.value = "";

      switch (etapa) {
        case "menu":
          if (["1", "2", "3"].includes(text)) {
            denuncia.tipo = text === "1" ? "Rolezinho" : text === "2" ? "Adega" : "Estacionamento irregular";
            etapa = "local";
            addMessage(`üìç Informe o local da ocorr√™ncia relacionada a ${denuncia.tipo}:`, "bot");
          } else if (text === "4") {
            addMessage("‚úÖ Obrigado! Atendimento encerrado. üö¶", "bot");
          } else {
            addMessage("Op√ß√£o inv√°lida. Escolha 1, 2, 3 ou 4.", "bot");
          }
          break;

        case "local":
          denuncia.local = text;
          etapa = "data";
          addMessage("üìÖ Informe a data da ocorr√™ncia (ex: 15/10/2025):", "bot");
          break;

        case "data":
          denuncia.data_evento = text;
          etapa = "dia";
          addMessage("üóìÔ∏è Informe o dia da semana (ex: ter√ßa-feira):", "bot");
          break;

        case "dia":
          denuncia.dia_semana = text;
          etapa = "inicio";
          addMessage("‚è∞ Informe o hor√°rio de in√≠cio (ex: 20:00):", "bot");
          break;

        case "inicio":
          denuncia.inicio = text;
          etapa = "fim";
          addMessage("‚è∞ Informe o hor√°rio de t√©rmino (ex: 23:30):", "bot");
          break;

        case "fim":
          denuncia.fim = text;
          etapa = "obs";
          addMessage("üìù Deseja adicionar alguma observa√ß√£o?", "bot");
          break;

        case "obs":
          denuncia.obs = text || "Nenhuma observa√ß√£o.";
          etapa = "confirmar";
          addMessage(`‚úÖ Confirme os dados da den√∫ncia:
Tipo: ${denuncia.tipo}
Local: ${denuncia.local}
Data: ${denuncia.data_evento}
Dia: ${denuncia.dia_semana}
In√≠cio: ${denuncia.inicio}
Fim: ${denuncia.fim}
Observa√ß√£o: ${denuncia.obs}`, "bot");
          addMessage("Deseja enviar esta den√∫ncia? (1 - Sim / 2 - Cancelar)", "bot");
          break;

        case "confirmar":
          if (text === "1") {
            try {
              const res = await fetch("/denuncia", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  tipo: denuncia.tipo,
                  local: denuncia.local,
                  data_evento: denuncia.data_evento,
                  dia_semana: denuncia.dia_semana,
                  hora_inicio: denuncia.inicio,
                  hora_fim: denuncia.fim,
                  observacoes: denuncia.obs
                })
              });
              const data = await res.json();
              if (data.success) {
                addMessage("‚úÖ Den√∫ncia registrada com sucesso! Ser√° analisada pela equipe de fiscaliza√ß√£o do DETRAN-AM conforme o CTB e o MBFT.", "bot");
              } else {
                addMessage("‚ùå Erro ao registrar den√∫ncia. Tente novamente.", "bot");
              }
            } catch (error) {
              addMessage("‚ùå Erro de conex√£o. Verifique o servidor.", "bot");
            }
            mostrarMenu();
          } else {
            addMessage("Den√∫ncia cancelada. Voltando ao menu principal.", "bot");
            mostrarMenu();
          }
          break;
      }
    }
  </script>
</body>
</html>
